---
import ActivityCard from './ActivityCard.astro';

interface Activity {
  title: string;
  categories: string[];
  description: string;
}

interface Props {
  name: string;
  activities: Activity[];
  categoryInfo: Record<string, string>;
}

const { name, activities, categoryInfo } = Astro.props;
const uniqueCategories = Object.keys(categoryInfo);
---

<section class="prose mb-28 max-w-3xl prose-img:border-0">
  <h1 class="text-2xl tracking-wider sm:text-3xl">{name}</h1>

  <div class="mb-8 flex flex-wrap gap-2">
    {uniqueCategories.map(category => (
      <button
        class="category-btn px-3 py-1 border rounded-full hover:bg-gray-100 transition-colors"
        data-category={category}
      >
        {category} {categoryInfo[category]}
      </button>
    ))}
  </div>

  <div id="activities-container">
    {activities.map(activity => (
      <ActivityCard
        title={activity.title}
        categories={activity.categories}
      >
        {activity.description}
      </ActivityCard>
    ))}
  </div>
</section>

<script>
  function setupFilters() {
    // Keep track of selected categories
    const selected = new Set();

    // Clean up any existing handlers by cloning and replacing buttons
    const buttonContainer = document.querySelector('.mb-8');
    if (buttonContainer) {
      const newContainer = buttonContainer.cloneNode(true);
      buttonContainer.parentNode.replaceChild(newContainer, buttonContainer);
    }

    // Add click handlers to category buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
      // Restore any previously selected state
      if (btn.classList.contains('bg-gray-200')) {
        const category = btn.getAttribute('data-category');
        selected.add(category);
      }

      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');

        // Toggle button state
        btn.classList.toggle('bg-gray-200');

        // Update selected categories
        if (selected.has(category)) {
          selected.delete(category);
        } else {
          selected.add(category);
        }

        // Filter activities
        document.querySelectorAll('article').forEach(article => {
          const show = selected.size === 0 ||
            Array.from(selected).every(cat => article.classList.contains(cat));
          article.classList.toggle('hidden', !show);
        });
      });
    });
  }

  // Run on first load (using DOMContentLoaded for initial page load)
  document.addEventListener('DOMContentLoaded', setupFilters);

  // Re-run when navigating back to the page
  document.addEventListener('astro:page-load', setupFilters);
</script>